# Debug TDW

## Problems with installing TDW

#### `AttributeError: module 'enum' has no attribute 'IntFlag'`

If you see this error after [installing the `tdw` module](../getting_started.md#Installation), try running `pip3 uninstall enum34`. Then, try installing the `tdw` module again.

#### `ERROR: Could not install packages due to an EnvironmentError: [WinError 5] Access is denied: 'c:\program files\python37\Lib\site-packages\tdw' Consider using the `--user` option or check the permissions.`

This occurs on Windows with Python 3.7+. Install with the --user flag: `pip3 install tdw --user`

***

## Problems with your controller

Beyond basic coding practices (breakpoints, unit tests, etc.) in your controller, here are several strategies for debugging your controller code:

### 1. Send Log Messages

```python
c.communicate({"$type": "send_log_messages"})
```

If you send this [command](../api/command_api.md), you will receive [Log Messages](../api/output_data.md) per frame. These messages will help tell you if you've made a mistake. They _won't_ tell you if the build has crashed (because in that case, the build can't send anything!)

The player log (see below) contains all of these messages, plus any others that weren't handled by the TDW logger (such as an unhandled exception in the Unity Engine).

### 2. Use the DebugController class

[`DebugController`](../python/debug_controller.md) is a subclass of [`Controller`](../python/controller.md) that will record every list of commands sent to the build. You can review these commands to reproduce bugs or identify problems.

Because `DebugController` holds all previous commands in memory, it is not recommended for long-term simulations.

See `Python/example_controllers/debug.py` for example implementation.

### 3. Read the player log for errors

**To locate the player log:** https://docs.unity3d.com/Manual/LogFiles.html. This will be found on the machine or docker container running the build.

This will contain all messages, warnings, errors, and exceptions logged by the Editor or standalone player (the build).

#### `Open GL Error`

These happen in Linux if you use certain model (typically lamps) or streamed scenes. 

**Fix:** Run the build in OpenGL 4.2:

```bash
./TDW.x86_64 -force-glcore42
```

The build defaults to OpenGL 4.5. OpenGL 4.2 seems to work reliably, but the build will have lower image quality.

#### `NullReferenceException`

This usually means that one or more fields in your commands is incorrect (i.e. you're sending the ID of an object that doesn't exist in the scene).

**Fix:** Proofread your commands. If problems still persist, add a GitHub Issue.

#### `WARNING: Shader Unsupported`

Harmless; it is auto-generated by Unity3D.

#### ` The referenced script on this Behaviour (Game Object '<NAME>') is missing!`

Harmless.

#### `XR: OpenVR Error!`

This error is logged when you don't have the required libraries to use VR. Unless you want to use VR, it's harmless.

#### `Desktop is 0 x 0 @ 0 Hz`

This usually occurs on Linux headless servers. It means that you haven't set up X or launched your build on a valid display. If you see this error in the log, it means that the build can't respond to any commands that you send from a controller.

**Fix:** See [Getting Started](../getting_started.md) for how to launch the build on a headless server; note that there must be a valid virtual display.

#### [Linux]: Segfault

Segfaults are rare and relatively hard to debug. Below is are some potential solutions; if they don't work, please contact us for help.

1. **Fix:** Make sure that unzip didn't fail and that the executable (`TDW.x86_64`) is in the same directory as `TDW_Data`:

```
TDW/
....TDW_Data/
....TDW.x86_64
```

2. **Fix:** Send `use_pre_signed_urls`. Do this if your controller is segfaulting while download models from models_full.json. You only need to send this command once (before downloading the models).

```python
from tdw.controller import Controller
from tdw.tdw_utils import TDWUtils

c = Controller(launch_build=False)
c.start()
c.communicate([TDWUtils.create_empty_room(12, 12),
               {"$type": "use_pre_signed_urls",
                "value": True},
               c.get_add_object(model_name="004_rose_pink",
                                library="models_full.json",
                                object_id=0)])
c.communicate({"$type": "terminate"})
```

#### [Windows]: `The code execution cannot proceed because UnityPlayer.dll was not found. Reinstalling the program may fix this problem.`

**Fix:**  Make sure that the executable `TDW.exe` is in the same folder as the other unzipped files:

```
TDW/
....MonoBleedingEdge/
....TDW_Data/
....UnityCrashHandler64.exe
....UnityPlayer.dll
....TDW.exe
```

#### `[warn] kq_init: detected broken kqueue; not using.: Undefined error: 0`

This error can occur when using the [AssetBundleCreator](add_local_object.md) and is caused by problems with your Unity license. 

**Fix:** Make sure you have valid and active Unity credentials.

#### `Newtonsoft.Json.JsonSerializationException`

One or more of the commands you sent isn't formatted correctly. This message should indicate the position of the error in the JSON string.

### 4. Network Problems

#### `zmq.error.ZMQError: Address in use`

There is another process (probably another controller) currently running and using the same port that your controller is trying to use. Kill that process in order to run your controller.

### The controller pauses while sending a message to the build

Occasionally, the synchronous send-receive socket pattern between the controller and the build will fail. This seems to be an inevitable on Linux servers; we've never seen this problem on Windows.

Should the connection fail, the build will automatically reconnect after a certain timeout duration and ask the controller to re-send the last message. This won't advance the simulation's physics or rendering state but there will be a several-second pause between messages.

To adjust the timeout duration, send [`set_socket_timeout`](../api/command_api#set_socket_timeout).

### The controller hangs indefinitely

This is usually because another process (such as another instance of a TDW build) that is using the same port and received a message intended for the TDW build. Either stop all TDW build processes before launching TDW, or launch TDW on a unique port (see [Getting Started](../getting_started.md)).

## Common OS X Problems

See [OS X documentation](osx.md).